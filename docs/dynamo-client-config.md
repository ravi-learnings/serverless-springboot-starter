# Shared DynamoDB client configuration

This document explains how to configure a shared DynamoDB client in a Spring Boot application.

# Workflow

## DynamoDB Configuration
- Create a DynamoDBConfig class to create a dynamodb client and enhanced client.

```java
@Bean
public DynamoDbClient dynamoDbClient() {
   return DynamoDbClient.builder().region(Region.US_EAST_1).build();
}

@Bean
public DynamoDbEnhancedClient dynamoDbEnhancedClient(DynamoDbClient dynamoDbClient) {
   return DynamoDbEnhancedClient.builder().dynamoDbClient(dynamoDbClient).build();
}
```

## Dynamo DB Abstract Entity

- Add a AbstractEntity that contains common attributes for all entities.
  - hashKey: String
  - rangeKey: String
  - createdAt: Instant
  - updatedAt: Instant (DynamoDbAutoGeneratedTimestampAttribute annotation)
  - https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/ddb-en-client-extensions.html#ddb-en-client-extensions-AGTE-

## DynamoDBClient class
- A class that contains all the common methods to interact with DynamoDB.
 

```declarative
// CreateTable
customerTable.createTable();

// Maps a physical table with the name 'customers_20190205' to the schema
DynamoDbTable<Customer> customerTable = enhancedClient.table("customers_20190205", CUSTOMER_TABLE_SCHEMA);

// GetItem
Customer customer = customerTable.getItem(Key.builder().partitionValue("a123").build());

// UpdateItem
Customer updatedCustomer = customerTable.updateItem(customer);

// PutItem
customerTable.putItem(customer);

// DeleteItem
Customer deletedCustomer = customerTable.deleteItem(Key.builder().partitionValue("a123").sortValue(456).build());

// Query
PageIterable<Customer> customers = customerTable.query(keyEqualTo(k -> k.partitionValue("a123")));

// Scan
PageIterable<Customer> customers = customerTable.scan();

// BatchGetItem
BatchGetResultPageIterable batchResults = enhancedClient.batchGetItem(r -> r.addReadBatch(ReadBatch.builder(Customer.class)
                                                                            .mappedTableResource(customerTable)
                                                                            .addGetItem(key1)
                                                                            .addGetItem(key2)
                                                                            .addGetItem(key3)
                                                                            .build()));

// BatchWriteItem
batchResults = enhancedClient.batchWriteItem(r -> r.addWriteBatch(WriteBatch.builder(Customer.class)
                                                                            .mappedTableResource(customerTable)
                                                                            .addPutItem(customer)
                                                                            .addDeleteItem(key1)
                                                                            .addDeleteItem(key1)
                                                                            .build()));

// TransactGetItems
transactResults = enhancedClient.transactGetItems(r -> r.addGetItem(customerTable, key1)
                                                        .addGetItem(customerTable, key2));

// TransactWriteItems
enhancedClient.transactWriteItems(r -> r.addConditionCheck(customerTable, 
                                                           i -> i.key(orderKey)
                                                                 .conditionExpression(conditionExpression))
                                        .addUpdateItem(customerTable, customer)
                                        .addDeleteItem(customerTable, key));
```

### Using secondary indices

```java
DynamoDbIndex<Customer> customersByName = customerTable.index("customers_by_name");
    
SdkIterable<Page<Customer>> customersWithName = 
    customersByName.query(r -> r.queryConditional(keyEqualTo(k -> k.partitionValue("Smith"))));

PageIterable<Customer> pages = PageIterable.create(customersWithName);

```

## Excluding attributes from serialization

- @DynamoDbIgnore 
- @DynamoDbUpdateBehavior(UpdateBehavior.WRITE_IF_NOT_EXISTS)
- @DynamoDbAutoGeneratedTimestampAttribute(DynamoDbAutoGeneratedTimestampAttributeType.UPDATE)

----------------------------------------------------------------------------------------------------------------------------

## Example
- Let's create a School, Student entities that extends AbstractEntity.
- Create a shared DynamoDbClient class that contains all the common methods to interact with DynamoDB.